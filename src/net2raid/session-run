#!/usr/bin/python

# Copyright 2011 MIT Haystack Observatory
# 
# This file is part of Mark6.
# 
# Mark6 is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
# 
# Mark6 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with Mark6.  If not, see <http://www.gnu.org/licenses/>.

import subprocess
import time
import sys
import optparse
from xml.etree.ElementTree import ElementTree
import datetime

class Session:

	polling_interval = 0.1

	def __init__(self, scan_list):
		self._scan_list = scan_list

	def execute(self):
		for s in self._scan_list:
			print s
			sleep_time = s._duration
			print 'args', s.args()

			if s.late():
				print 'skipping late scan ', time.time(), s
				continue

			while time.time() < s._start_time:
				time.sleep(Session.polling_interval)

			print 'start', time.time(), s._start_time

			start_time = time.time()
			p = subprocess.Popen(s.args())
			p.wait()	
			duration = time.time() - start_time
			print 'duration', sleep_time, duration
			print '\n',


class Scan:

	mark6_exec = '/opt/mit/mark6/bin/net2raid-run'

	def __init__(self, experiment_name, source, station, start_time, duration):
		self._experiment_name = experiment_name
		self._source = source
		self._station = station
		self._start_time = start_time
		self._duration = duration
		self._end_time = start_time + duration

		# <exp name>_<station code>_<scan name>[_<data start time>_<aux info1>_<aux info2>...].<file type>
		d = datetime.datetime.fromtimestamp(self._start_time)
		print d.year, d.month, d.day, d.hour, d.minute, d.second
		start_time_str = '%d%d%d%d%d%d'%(d.year, d.month, d.day, d.hour, d.minute, d.second)
		self._scan_name = '%s_%s_%s_%s.m6'%(experiment_name, station, source, start_time_str)

	def __str__(self):
		return ''.join([
			'<scan ',
			'experiment="%s" '%self._experiment_name,
			'source="%s" '%self._source,
			'station="%s" '%self._station,
			'start_time="%s" '%self._start_time,
			'duration="%s" '%self._duration,
			'scan_name="%s"'%self._scan_name,
			'/>'
			])

	def args(self):
		return [ Scan.mark6_exec, self._source, self._station,
			str(self._start_time), str(self._duration) ]

	def late(self):
		if time.time() > self._end_time:
			return True
		return False	


def test():
	print 'Running test schedule.'
	now = time.time()
	TEST_SCANS = [
		('4242', 'WESTFORD', now+60, 5),
		('4243', 'WESTFORD', now+20, 7),
		('4244', 'WESTFORD', now+30, 9),
		('4245', 'WESTFORD', now+40, 11),
		]

	scan_list = []
	for s in TEST_SCANS:
		sr, st, t, d = s
		print time.time(), t
		scan_list.append(Scan(source=sr, station=st, start_time=t, duration=d))

	session = Session(scan_list)
	session.execute()


def run_schedule(schedule):
	print 'Running schedule:', schedule
	tree = ElementTree()
	tree.parse(schedule)
	experiment = tree.getroot()
	experiment_name = experiment.attrib['name']
	scans = list(tree.findall('scan'))
	scan_list = []
	for s in scans:
		a = s.attrib
		scan_list.append(Scan(experiment_name=experiment_name,
					source=a['source'],
					station=a['station'],
					start_time=int(a['start_time']),
					duration=int(a['duration'])))
	
	session = Session(scan_list)
	session.execute()
	

if __name__ == '__main__':
	parser = optparse.OptionParser()
	parser.add_option('-s', '--schedule', dest='schedule', help='Schedule ')
	parser.add_option('-t', '--test', action='store_true', dest='test', help='Run a test schedule based on current time.',
			default=False)

	(o, a) = parser.parse_args()

	if o.test:
		test()
		sys.exit(0)

	if o.schedule:
		run_schedule(o.schedule)
		sys.exit(0)
